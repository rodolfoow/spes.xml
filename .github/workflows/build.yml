name: Build Pixel Experience - spes

on:
  workflow_dispatch: # Build-ni GitHub orqali qo'lda ishga tushirish uchun

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      # 1. GitHub Repository kodlarini yuklab olish
      - name: Checkout Repository
        uses: actions/checkout@v4

      # 2. Crave CLI-ni eng ishonchli usulda o'rnatish
      - name: Install Crave CLI
        run: |
          # API orqali eng so'nggi versiyani aniqlash va 'crave' nomli fayl sifatida yuklab olish
          # 'User-Agent' sarlavhasi GitHub API talabi hisoblanadi
          curl -sL \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            -H "User-Agent: GitHub-Actions-Workflow" \
            "https://api.github.com" | \
          grep "browser_download_url" | grep "linux" | cut -d '"' -f 4 | wget -qi - -O crave
          
          # Faylga ruxsat berish
          chmod +x crave
          
          # Uni tizim PATH-iga o'tkazish
          sudo install crave /usr/local/bin
          
          # O'rnatilganligini tekshirish
          crave --version

      # 3. GitHub Secrets orqali crave.conf faylini sozlash
      - name: Set up Crave Config
        run: |
          mkdir -p ~/.crave
          echo "username: ${{ secrets.CRAVE_USERNAME }}" > ~/.crave/crave.conf
          echo "authToken: ${{ secrets.CRAVE_TOKEN }}" >> ~/.crave/crave.conf

      # 4. Build jarayonini boshlash
      - name: Start Build on Crave
        run: |
          crave run -- " \
          # ROM bazasini sozlash (Android 13)
          repo init -u https://github.com -b thirteen --depth=1 ; \
          
          # Sayann70 local manifestini qo'shish (spes uchun tree-lar)
          rm -rf .repo/local_manifests ; \
          mkdir -p .repo/local_manifests ; \
          curl -L https://raw.githubusercontent.com > .repo/local_manifests/spes.xml ; \
          
          # Kodlarni yuklab olish (Sync)
          repo sync -c -j\$(nproc --all) --force-sync --no-clone-bundle --no-tags ; \
          
          # Build-ni boshlash
          source build/envsetup.sh ; \
          lunch aosp_spes-userdebug ; \
          m bacon -j\$(nproc --all) \
          "
          
